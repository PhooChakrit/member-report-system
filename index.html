<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรายงานสมาชิก</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: #667eea;
            font-size: 1.1rem;
        }

        .date-picker-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            max-width: 300px;
        }

        .date-input-group label {
            font-weight: 500;
            color: #4a5568;
            font-size: 0.95rem;
        }

        .date-input-wrapper {
            position: relative;
            width: 100%;
        }

        .date-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            pointer-events: none;
        }

        .date-input {
            width: 100%;
            padding: 12px 15px;
            padding-right: 40px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background: #f7fafc;
            cursor: pointer;
        }

        .date-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            color: #667eea;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 35px;
            height: 35px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            background: #f7fafc;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.9rem;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
            font-size: 0.9rem;
        }

        tr:hover {
            background: #f7fafc;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .export-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .export-btn:hover {
            background: #38a169;
            transform: translateY(-1px);
        }

        .chart-container {
            position: relative;
            height: 350px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e2e8f0;
        }

        .current-date {
            text-align: center;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .results-container {
            display: none;
        }

        .results-container.show {
            display: block;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 90%;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast i {
            font-size: 1.2rem;
        }

        .toast-content {
            flex: 1;
        }

        .error-message {
            color: #ef4444;
            text-align: center;
            padding: 15px;
            font-weight: 500;
            margin-top: 10px;
            display: none;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            border-left: 4px solid #ef4444;
        }

        .error-message.show {
            display: block;
        }

        .error-details {
            font-size: 0.85rem;
            margin-top: 8px;
            color: #7f1d1d;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .section {
                padding: 15px;
            }

            .section-title {
                font-size: 1.1rem;
            }

            .chart-container {
                height: 300px;
                padding: 10px;
            }

            th,
            td {
                padding: 12px 10px;
                font-size: 0.85rem;
            }

            .date-input {
                padding: 10px 15px;
                padding-right: 35px;
            }

            .date-icon {
                right: 12px;
                font-size: 0.9rem;
            }

            .submit-btn {
                padding: 10px 20px;
                font-size: 0.95rem;
            }

            .toast {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: calc(100% - 20px);
            }
        }

        .flatpickr-calendar {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .flatpickr-day.selected {
            background: #667eea;
            border-color: #667eea;
        }

        .flatpickr-day.today {
            border-color: #667eea;
        }

        .flatpickr-day:hover {
            background: #e2e8f0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-users"></i> ระบบรายงานสมาชิก</h1>
            <p>ระบบจัดการและรายงานข้อมูลสมาชิกแบบครบวงจร</p>
        </div>

        <div class="section">
            <div class="section-title">
                <i class="fas fa-calendar-alt"></i>
                เลือกวันที่รายงาน
            </div>
            <div class="date-picker-container">
                <div class="date-input-group">
                    <label for="report-date">วันที่ (พ.ศ.)</label>
                    <div class="date-input-wrapper">
                        <input type="text" id="report-date" class="date-input" placeholder="วว/ดด/ปปปป (พ.ศ.)" readonly>
                        <i class="fas fa-calendar-alt date-icon"></i>
                    </div>
                </div>
                <button id="submit-btn" class="submit-btn">
                    <i class="fas fa-search"></i>
                    สร้างรายงาน
                </button>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>กำลังโหลดข้อมูล...</p>
        </div>

        <div id="error-message" class="error-message">
            <div id="error-content"></div>
            <div id="error-details" class="error-details"></div>
        </div>

        <div id="results-container" class="results-container">
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-table"></i>
                    ตารางข้อมูลสมาชิก
                </div>
                <div class="current-date" id="current-date"></div>
                <div class="table-wrapper">
                    <table id="member-table">
                        <thead>
                            <tr>
                                <th>ประเภทสมาชิก</th>
                                <th>จำนวน (คน)</th>
                                <th>สัดส่วน (%)</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                    </table>
                </div>
                <div style="text-align: right;">
                    <button id="export-btn" class="export-btn">
                        <i class="fas fa-file-excel"></i>
                        ส่งออก Excel
                    </button>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    <i class="fas fa-chart-pie"></i>
                    กราฟแสดงสัดส่วนสมาชิก
                </div>
                <div class="chart-container">
                    <canvas id="members-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>
    <script>
        class MemberReportSystem {
            constructor() {
                this.chartInstance = null;
                this.currentData = null;
                this.init();
            }

            init() {
                this.setupDatePicker();
                this.setupEventListeners();
                this.setDefaultDate();
            }

            setupDatePicker() {
                flatpickr("#report-date", {
                    dateFormat: "d/m/Y",
                    locale: "th",
                    onChange: (selectedDates, dateStr) => {
                        if (selectedDates.length > 0) {
                            const selectedDate = selectedDates[0];
                            const buddhistYear = selectedDate.getFullYear() + 543;
                            const formattedDate = dateStr.replace(/\d{4}$/, buddhistYear);
                            document.getElementById('report-date').value = formattedDate;
                            document.getElementById('report-date').dataset.isoDate = selectedDate.toISOString().split('T')[0];
                        }
                    }
                });
            }

            setDefaultDate() {
                const today = new Date();
                const buddhistYear = today.getFullYear() + 543;
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const dateInput = document.getElementById('report-date');
                dateInput.value = `${day}/${month}/${buddhistYear}`;
                dateInput.dataset.isoDate = today.toISOString().split('T')[0];
            }

            setupEventListeners() {
                document.getElementById('submit-btn').addEventListener('click', () => {
                    this.generateReport();
                });

                document.getElementById('export-btn').addEventListener('click', () => {
                    this.exportToExcel();
                });
            }

            showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    <div class="toast-content">${message}</div>
                `;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 5000);
            }

            showError(message, details = '') {
                const errorMessage = document.getElementById('error-message');
                document.getElementById('error-content').textContent = message;
                document.getElementById('error-details').textContent = details;
                errorMessage.classList.add('show');
            }

            hideError() {
                document.getElementById('error-message').classList.remove('show');
            }


            getCorsProxyUrl(url) {
                return `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
            }

            async fetchMemberData(isoDate) {
                try {
                    const proxyUrl = this.getCorsProxyUrl(
                        `https://learningportal.ocsc.go.th/learningspaceapi/reports/1?lastdate=${isoDate}`
                    );

                    const response = await fetch(proxyUrl);
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('404 Not Found - ไม่พบข้อมูล');
                        } else if (response.status === 500) {
                            throw new Error('500 Internal Server Error - ข้อผิดพลาดเซิร์ฟเวอร์');
                        } else if (response.status === 408) {
                            throw new Error('408 Request Timeout - การร้องขอหมดเวลา');
                        } else {
                            throw new Error(`HTTP Error ${response.status}: ${response.statusText}`);
                        }
                    }

                    const data = await response.json();

                    if (!data || !Array.isArray(data.x) || !Array.isArray(data.y)) {
                        throw new Error('รูปแบบข้อมูลจาก API ไม่ถูกต้อง');
                    }

                    return {
                        categories: data.x,
                        counts: data.y
                    };

                } catch (error) {
                    console.error('Error fetching data:', error);
                    throw error;
                }
            }

            async generateReport() {
                const dateInput = document.getElementById('report-date');
                const isoDate = dateInput.dataset.isoDate;

                if (!isoDate) {
                    this.showToast('กรุณาเลือกวันที่');
                    return;
                }

                this.hideError();
                document.getElementById('results-container').classList.remove('show');
                document.getElementById('loading').classList.add('show');

                try {
                    const data = await this.fetchMemberData(isoDate);

                    this.renderTable(data);
                    this.renderChart(data);
                    this.updateCurrentDate(dateInput.value);

                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('results-container').classList.add('show');

                } catch (error) {
                    console.error('Error:', error);
                    this.showToast(`เกิดข้อผิดพลาด: ${error.message}`);

                    let errorDetails = '';
                    if (error.message.includes('500')) {
                        errorDetails = 'เซิร์ฟเวอร์ประสบปัญหาภายใน กรุณาลองใหม่ในภายหลัง';
                    } else if (error.message.includes('408')) {
                        errorDetails = 'การเชื่อมต่อใช้เวลานานเกินไป กรุณาลองใหม่หรือตรวจสอบเครือข่ายของคุณ';
                    } else {
                        errorDetails = 'ไม่สามารถดึงข้อมูลได้ กรุณาตรวจสอบวันที่หรือลองใหม่ภายหลัง';
                    }

                    this.showError(`เกิดข้อผิดพลาด: ${error.message}`, errorDetails);

                    document.getElementById('loading').classList.remove('show');
                }
            }

            renderTable(data) {
                const tableBody = document.getElementById('table-body');
                tableBody.innerHTML = '';


                if (!data || !data.counts || !data.categories ||
                    !Array.isArray(data.counts) || !Array.isArray(data.categories)) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="3" style="text-align: center; color: #ef4444;">ไม่มีข้อมูลหรือข้อมูลไม่ถูกต้อง</td>`;
                    tableBody.appendChild(row);
                    return;
                }

                const total = data.counts.reduce((sum, count) => sum + count, 0);

                data.categories.forEach((category, index) => {
                    const count = data.counts[index] || 0;
                    const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${category || 'ไม่มีชื่อประเภท'}</td>
                        <td>${count.toLocaleString()}</td>
                        <td>${percentage}%</td>
                    `;
                    tableBody.appendChild(row);
                });

                const totalRow = document.createElement('tr');
                totalRow.style.fontWeight = 'bold';
                totalRow.style.backgroundColor = '#f7fafc';
                totalRow.innerHTML = `
                    <td>รวมทั้งหมด</td>
                    <td>${total.toLocaleString()}</td>
                    <td>100.0%</td>
                `;
                tableBody.appendChild(totalRow);

                this.currentData = data;
            }

            renderChart(data) {
                const ctx = document.getElementById('members-chart').getContext('2d');

                if (this.chartInstance) {
                    this.chartInstance.destroy();
                }


                if (!data || !data.counts || !data.categories ||
                    !Array.isArray(data.counts) || !Array.isArray(data.categories)) {
                    return;
                }

                const colors = [
                    '#667eea',
                    '#764ba2',
                    '#f093fb',
                    '#f5576c',
                    '#4facfe'
                ];

                this.chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.categories,
                        datasets: [{
                            data: data.counts,
                            backgroundColor: colors,
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    },
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((context.raw / total) * 100);
                                        return `${context.label}: ${context.raw.toLocaleString()} คน (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '60%'
                    }
                });
            }

            updateCurrentDate(buddhistDate) {
                document.getElementById('current-date').textContent = `ข้อมูล ณ วันที่ ${buddhistDate}`;
            }

            exportToExcel() {
                if (!this.currentData) return;

                const table = document.getElementById('member-table');
                const ws = XLSX.utils.table_to_sheet(table);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "รายงานสมาชิก");

                const dateInput = document.getElementById('report-date');
                const christianDate = dateInput.dataset.isoDate.replace(/-/g, '');
                XLSX.writeFile(wb, `member_report_${christianDate}.xlsx`);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new MemberReportSystem();
        });
    </script>
</body>

</html>